# 快速测试指南 - 审批提醒功能

## 问题已修复 ✅

之前的问题是：文件修改没有正确保存，导致运行的还是旧代码。

现在所有文件已经正确更新并保存。

---

## 立即测试步骤

### 1. 确保服务正在运行

**后端服务**（如果还没启动）：
```bash
cd backend
python -m uvicorn app.main:app --reload
```

**前端服务**（已经在后台运行）：
```bash
cd frontend
npm run dev
```

### 2. 清除浏览器缓存

重要！必须清除缓存：

**方法1 - 硬刷新**：
- Windows: `Ctrl + F5` 或 `Ctrl + Shift + R`
- Mac: `Cmd + Shift + R`

**方法2 - 清除缓存**：
1. 打开浏览器开发者工具（F12）
2. 右键点击刷新按钮
3. 选择"清空缓存并硬性重新加载"

### 3. 测试发送提醒

1. 登录系统：http://localhost:5173
2. 进入"审批工作台"
3. 找到一个有待处理任务的教师
4. 点击该行的"更多"按钮
5. 点击"发送提醒"

**预期结果：**
- ✅ 弹出提示："已成功发送 X 条提醒通知"
- ❌ 不再显示："已向责任人发送提醒（模拟）"

### 4. 验证通知接收

#### A. 查看通知图标
- 导航栏右上角的铃铛图标
- 应该显示未读数量徽章

#### B. 查看通知详情
1. 点击用户头像
2. 选择"个人中心"
3. 切换到"通知消息"选项卡
4. 查看最新的提醒通知

**通知内容示例：**
```
标题：审批提醒：张三 - 资格审核
内容：李四 提醒您：张三（数学组）的"资格审核"阶段待处理，截止日期：2025-01-20。
类型：待审批（橙色标签）
状态：未读（高亮显示）
```

---

## 浏览器控制台验证

### 查看网络请求

1. 打开开发者工具（F12）
2. 切换到 Network（网络）选项卡
3. 点击"发送提醒"
4. 找到 `send-reminder` 请求

**正确的请求：**
```
Request URL: http://localhost:8000/api/approvals/tasks/send-reminder?teacher_name=张三&department=数学组
Request Method: POST
Status Code: 200 OK
```

**正确的响应：**
```json
{
  "success": true,
  "message": "已成功发送 2 条提醒通知",
  "notification_count": 2
}
```

**错误的响应（之前的问题）：**
```json
{
  "unread_count": 0
}
```

如果还看到错误的响应，说明浏览器缓存没有清除干净。

---

## 完整测试场景

### 场景1：单个任务提醒

1. 找到一个只有一个待处理阶段的教师
2. 发送提醒
3. 切换到该阶段负责人的账号
4. 查看通知，应该看到：
   ```
   标题：审批提醒：XX教师 - XX阶段
   内容：包含具体阶段名称和截止日期
   ```

### 场景2：多个任务提醒

1. 找到一个有多个待处理阶段的教师
2. 发送提醒
3. 多个负责人都应该收到通知
4. 通知内容：
   ```
   标题：审批提醒：XX教师 有 N 个审批阶段待处理
   内容：汇总信息
   ```

### 场景3：从审批进度详情发送

1. 点击某教师的"查看进度"按钮
2. 在打开的抽屉中，滚动到底部
3. 点击"提醒责任人"按钮
4. 应该看到成功提示

---

## 常见问题排查

### Q1: 还是显示"模拟"提示

**解决方案：**
1. 停止前端服务（Ctrl+C）
2. 清除浏览器所有缓存（包括 localStorage）
3. 重新启动：`npm run dev`
4. 硬刷新浏览器（Ctrl+F5）

### Q2: 返回 404 错误

**检查：**
1. 后端服务是否运行：访问 http://localhost:8000/docs
2. 在 API 文档中搜索 `send-reminder`
3. 如果找不到，重启后端服务

### Q3: 返回 403 权限错误

**原因：**
- 当前用户没有审批权限

**解决：**
- 使用管理员账号登录
- 或者给当前用户添加 `contracts.audit` 权限

### Q4: 返回 404 "未找到待处理的审批任务"

**原因：**
- 该教师的所有审批任务都已完成
- 或者没有审批任务

**解决：**
- 选择另一个有待处理任务的教师
- 或者创建新的审批任务

---

## 验证代码已更新

### 检查前端代码

打开 `frontend/src/pages/Approvals.tsx`，搜索 `case "remind"`：

**正确的代码：**
```typescript
case "remind":
  sendReminderMutation.mutate({
    contractId: teacher.contract_id,
    teacherName: teacher.teacher_name,
    department: teacher.department,
  })
  break
```

**错误的代码（旧版本）：**
```typescript
case "remind":
  notifySuccess("已向责任人发送提醒（模拟）")
  break
```

如果看到错误的代码，说明文件没有保存，请保存后重新测试。

---

## 成功标志

✅ **功能正常工作的标志：**

1. 点击"发送提醒"后，提示："已成功发送 X 条提醒通知"（X 是具体数字）
2. Network 选项卡显示 POST 请求到 `/approvals/tasks/send-reminder`
3. 响应包含 `success: true` 和 `notification_count`
4. 通知图标显示未读数量
5. 个人中心能看到新的提醒通知
6. 通知内容包含发送人姓名、教师信息、阶段名称

---

## 后续增强

功能已经完整实现，后续可以考虑：

1. **批量提醒** - 选择多个教师批量发送
2. **定时提醒** - 截止日期前自动提醒
3. **频率控制** - 24小时内不重复提醒
4. **邮件通知** - 同时发送邮件提醒
5. **提醒历史** - 记录提醒发送历史

---

*测试指南创建时间：2025-01-16*
*问题修复时间：2025-01-16*

如果测试成功，请给个反馈！👍

